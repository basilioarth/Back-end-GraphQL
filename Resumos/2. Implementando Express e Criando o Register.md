# Resumo da Aula 2 â€“ Configurando Express, Prisma, TypeGraphQL e Primeira Mutation de Cadastro

## Bibliotecas Instaladas
```bash
npm install @apollo/server express graphql prisma @prisma/client reflect-metadata type-graphql jsonwebtoken bcryptjs

npm install -D @types/express @types/jsonwebtoken @types/bcryptjs
```

## ConfiguraÃ§Ã£o do Prisma + SQLite
```bash
npx prisma init --datasource-provider sqlite
```
- Criada pasta `prisma/` com `schema.prisma`
- Definido primeiro model **User**:
```prisma
model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```
- Primeira migration:
```bash
npx prisma migrate dev --name create-user
npx prisma migrate dev --name change-user-email-unique
```

## MudanÃ§a do Servidor (de Standalone â†’ Express + Apollo Server)
- Removido `startStandaloneServer`
- Usado `express` + `apollo-server-express` (v5 â†’ `@as-integrations/express`)
- Schema agora Ã© gerado automaticamente com **TypeGraphQL**:
```ts
const schema = await buildSchema({
  resolvers: [/* resolvers aqui */],
  validate: false,
  emitSchemaFile: "schema.graphql"
});
```

## Estrutura de Pastas Criada
```
src/
â”œâ”€â”€ resolvers/
â”œâ”€â”€ inputs/
â”œâ”€â”€ outputs/
â”œâ”€â”€ models/
â”œâ”€â”€ services/
â”œâ”€â”€ utils/
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ client.ts    // singleton do PrismaClient com cache global
```

## Utils Criados
1. **hashPassword** (bcryptjs â€“ 10 rounds)
2. **signJwt**  
   - Payload: `{ id: string, email: string }`
   - Usa `process.env.JWT_SECRET`
   - Suporta `expiresIn` opcional

## Models GraphQL (TypeGraphQL)
- `UserModel` â†’ `@ObjectType()` com campos `@Field()`

## Input e Output do Cadastro
- `inputs/auth.input.ts` â†’ `RegisterInput` (`@InputType`)
- `outputs/auth.output.ts` â†’ `RegisterOutput`  
  ContÃ©m:
  - token (String!)
  - refreshToken (String!)
  - user (UserModel!)

## AuthService (services/auth.service.ts)
- Verifica se jÃ¡ existe usuÃ¡rio com o e-mail
- Gera hash do password
- Cria usuÃ¡rio no Prisma
- Gera **access token** (15 min) e **refresh token** (1 dia)
- Retorna `{ token, refreshToken, user }`

## AuthResolver (resolvers/auth.resolver.ts)
```ts
@Resolver()
export class AuthResolver {
  constructor(private readonly authService: AuthService) {}

  @Mutation(() => RegisterOutput)
  async register(@Arg("data") data: RegisterInput) {
    return this.authService.register(data);
  }
}
```

## Bootstrap Atualizado (src/index.ts)
- Cria app Express
- Aplica `express.json()`
- Inicia ApolloServer â†’ `server.start()`
- Usa middleware: `app.use("/graphql", expressMiddleware(server))`
- `app.listen(4000)`

## ObservaÃ§Ãµes Finais da Aula
- O servidor ainda nÃ£o sobe porque o Apollo Server exige **pelo menos uma Query**
- Na prÃ³xima aula serÃ¡ criado um `UserResolver` com uma query simples (ex: `user(id: ID!): User`) apenas para o servidor iniciar
- Depois disso serÃ¡ testada a mutation `register` completa com persistÃªncia no SQLite e retorno de JWT + refresh token

**Tudo configurado: Express + TypeGraphQL + Prisma + JWT + Hash de senha. SÃ³ falta a query mÃ­nima para o servidor rodar e jÃ¡ vamos poder testar o cadastro completo!**  
Bora pra prÃ³xima! ğŸš€