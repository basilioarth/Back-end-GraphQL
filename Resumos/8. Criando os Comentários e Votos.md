# Resumo da Aula 8 – Comentários + Votos (parte 1: Comments 100% funcionais)

## 1. Novos modelos no Prisma + Migration
```prisma
model Vote {
  id       String @id @default(uuid())
  userId   String
  ideaId   String

  user     User   @relation(fields: [userId], references: [id])
  idea     Idea   @relation(fields: [ideaId], references: [id])

  @@unique([userId, ideaId])   // ← um voto por usuário por ideia
  @@map("votes")
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorId  String
  ideaId    String

  author    User     @relation(fields: [authorId], references: [id])
  idea      Idea     @relation(fields: [ideaId], references: [id])

  @@map("comments")
}
```
Migration executada:
```bash
npx prisma migrate dev --name create-comments-and-votes
```

## 2. GraphQL Models criados
- `VoteModel` → id, userId, ideaId + relações user e idea
- `CommentModel` → id, content, createdAt, updatedAt + relações author (User) e idea (Idea)

## 3. Comentários – CRUD básico já funcionando

### Input
```ts
@InputType()
export class CreateCommentInput {
  @Field(() => String) content: string
}
```

### Service (CommentService)
```ts
async create(data: CreateCommentInput, ideaId: string, authorId: string) {
  const idea = await prismaClient.idea.findUnique({ where: { id: ideaId } });
  if (!idea) throw new Error("Ideia não encontrada");

  return prismaClient.comment.create({
    data: {
      content: data.content,
      ideaId,
      authorId
    }
  });
}
```

### Resolver (CommentResolver)
```ts
@Mutation(() => CommentModel)
@UseMiddleware(isAuth)
async createComment(
  @Arg("ideaId") ideaId: string,
  @Arg("data") data: CreateCommentInput,
  @GQLUser() user: User
) {
  return this.commentService.create(data, ideaId, user.id);
}
```

### Field Resolvers no CommentResolver
```ts
@FieldResolver(() => IdeaModel)
async idea(@Root() comment: CommentModel) {
  return this.ideaService.findIdeaById(comment.ideaId);
}

@FieldResolver(() => UserModel)
async author(@Root() comment: CommentModel) {
  return this.userService.findUser(comment.authorId);
}
```

## 4. Testes reais no Playground (tudo funcionando)
```graphql
mutation {
  createComment(
    ideaId: "clk9x...", 
    data: { content: "Comentário do Felipe" }
  ) {
    id
    content
    author { id name email }
    idea {
      title
      description
      author { name }
    }
    createdAt
  }
}
```
→ Comentário criado com autor e ideia completamente resolvidos

→ Testado com dois usuários diferentes (Felipe e João) → autor corretamente resolvido em cada caso

## 5. Sistema de votos (Vote) – estrutura pronta
- Modelo e tabela criados
- Constraint única por usuário/ideia implementada
- Ainda falta:
  - Mutation `voteIdea` / `removeVote`
  - FieldResolver para listar votos na ideia
  - Contador de votos (up/down ou apenas upvote)

## Estado atual do Mindshare (resumo visual)

| Funcionalidade         | Status      | Observação                                      |
|-------------------------|-------------|-------------------------------------------------|
| Cadastro / Login        | Done        | JWT + refresh token                             |
| Criar / Atualizar / Deletar ideia | Done        | Com @GQLUser automático                         |
| Listar ideias + autor   | Done        | FieldResolver funcionando                                 |
| Criar comentário        | Done        | Com autor e ideia resolvidos automaticamente     |
| Listar comentários da ideia | In progress | Próxima aula                                   |
| Sistema de votos        | In progress | Modelo pronto – implementação na próxima aula   |

Tudo rodando perfeitamente, com relacionamentos sendo resolvidos de forma limpa e automática graças aos FieldResolvers.

Próxima aula prometida:
- Listar comentários dentro da query `listIdeas` ou nova query `idea(id)`
- Implementar votação (upvote/downvote ou apenas upvote)
- Talvez contador de votos na ideia

O Mindshare já está virando uma rede social completa de ideias!  
Bora pra próxima aula que agora vem votação e listagem rica de comentários!